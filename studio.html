<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéôÔ∏è LynchFM –°—Ç—É–¥–∏—è</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
        }
        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            color: #00ffff;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00ffff;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        h2 {
            color: #00ffaa;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(0, 255, 170, 0.3);
            padding-bottom: 10px;
        }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        .offline { background: rgba(255, 50, 50, 0.2); border: 1px solid #ff3232; }
        .online { background: rgba(0, 255, 100, 0.2); border: 1px solid #00ff64; }
        .broadcasting { background: rgba(255, 200, 0, 0.2); border: 1px solid #ffc800; animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .btn {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(45deg, #00b4db, #0083b0);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 180, 219, 0.4);
        }
        .btn-danger {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white;
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 65, 108, 0.4);
        }
        .btn-success {
            background: linear-gradient(45deg, #00b09b, #96c93d);
            color: white;
        }
        .audio-select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 15px;
        }
        .drop-zone {
            border: 3px dashed #00ffff;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }
        .drop-zone:hover {
            background: rgba(0, 255, 255, 0.1);
            border-color: #00ffaa;
        }
        .drop-zone.dragover {
            background: rgba(0, 255, 255, 0.2);
            border-color: #00ff00;
        }
        .playlist {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .playlist-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .playlist-item.current {
            background: rgba(0, 255, 255, 0.2);
            border-left: 4px solid #00ffff;
        }
        .level-meter {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .level-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #00ffaa);
            width: 0%;
            transition: width 0.1s;
        }
        .controls-row {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }
        .volume-slider {
            flex-grow: 1;
        }
        .chat-box {
            height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
        }
        .message.system {
            color: #00ffff;
            font-style: italic;
        }
        .message.user {
            color: #00ffaa;
        }
    </style>
</head>
<body>
    <h1>üéôÔ∏è LynchFM –í–µ–±-–°—Ç—É–¥–∏—è</h1>
    <div class="subtitle">–ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä –≤ –æ–¥–∏–Ω –∫–ª–∏–∫ | MP3 —Ñ–∞–π–ª—ã | –í–µ–±-–º–∏–∫—Ä–æ—Ñ–æ–Ω</div>
    
    <div class="container">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–µ–π -->
        <div class="panel">
            <h2>üé§ –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤ –ø—Ä—è–º–æ–º —ç—Ñ–∏—Ä–µ</h2>
            
            <div id="status" class="status offline">
                ‚èπÔ∏è –°—Ç–∞—Ç—É—Å: –û–§–§–õ–ê–ô–ù
            </div>
            
            <div class="controls-row">
                <select id="audioInput" class="audio-select">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω...</option>
                </select>
                
                <button id="startBroadcastBtn" class="btn btn-primary">
                    ‚ñ∂Ô∏è –ù–ê–ß–ê–¢–¨ –≠–§–ò–†
                </button>
                <button id="stopBroadcastBtn" class="btn btn-danger" disabled>
                    ‚èπÔ∏è –°–¢–û–ü –≠–§–ò–†
                </button>
            </div>
            
            <h3>–£—Ä–æ–≤–µ–Ω—å –∑–≤—É–∫–∞:</h3>
            <div class="level-meter">
                <div id="levelFill" class="level-fill"></div>
            </div>
            
            <div class="audio-controls">
                <span>–ì—Ä–æ–º–∫–æ—Å—Ç—å:</span>
                <input type="range" id="volumeSlider" class="volume-slider" 
                       min="0" max="100" value="100">
                <span id="volumeValue">100%</span>
            </div>
            
            <div class="chat-box" id="chatBox">
                <div class="message system">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ LynchFM —Å—Ç—É–¥–∏—é!</div>
                <div class="message system">–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –Ω–∞—á–Ω–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é</div>
            </div>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ü–ª–µ–π–ª–∏—Å—Ç –∏ —Ñ–∞–π–ª—ã -->
        <div class="panel">
            <h2>üéµ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—É–∑—ã–∫–æ–π</h2>
            
            <div class="drop-zone" id="dropZone">
                üìÅ –ü–ï–†–ï–¢–ê–©–ò–¢–ï MP3 –§–ê–ô–õ–´ –°–Æ–î–ê<br>
                <small>–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</small>
            </div>
            <input type="file" id="fileInput" accept="audio/mp3,audio/*" multiple style="display: none;">
            
            <div class="controls-row">
                <button id="playMusicBtn" class="btn btn-success" disabled>
                    ‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
                </button>
                <button id="pauseMusicBtn" class="btn" disabled>
                    ‚è∏Ô∏è –ü–∞—É–∑–∞
                </button>
                <button id="stopMusicBtn" class="btn btn-danger" disabled>
                    ‚èπÔ∏è –°—Ç–æ–ø
                </button>
                <button id="nextTrackBtn" class="btn" disabled>
                    ‚è≠Ô∏è –°–ª–µ–¥—É—é—â–∏–π
                </button>
            </div>
            
            <h3>–ü–ª–µ–π–ª–∏—Å—Ç:</h3>
            <div class="playlist" id="playlist">
                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Ç—Ä–µ–∫–∏ -->
                <div class="playlist-item empty">
                    –ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ MP3 —Ñ–∞–π–ª—ã
                </div>
            </div>
            
            <div style="margin-top: 20px; color: #888; font-size: 0.9em;">
                <strong>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
                1. –í—ã–±–µ—Ä–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ<br>
                2. –î–æ–±–∞–≤—å—Ç–µ MP3 —Ñ–∞–π–ª—ã –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º<br>
                3. –ù–∞–∂–º–∏—Ç–µ "–ù–ê–ß–ê–¢–¨ –≠–§–ò–†" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏<br>
                4. –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –º—É–∑—ã–∫–æ–π –∫–Ω–æ–ø–∫–∞–º–∏ —Å–ø—Ä–∞–≤–∞
            </div>
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–π –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –º—É–∑—ã–∫–∏ -->
    <audio id="musicPlayer" crossorigin="anonymous"></audio>
    
    <script>
        // ============= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =============
        const SERVER_URL = 'wss://lynchfm-backend.onrender.com';
        const API_BASE = 'https://lynchfm-backend.onrender.com';
        
        // ============= –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =============
        const state = {
            isBroadcasting: false,
            isPlayingMusic: false,
            currentMicrophone: null,
            currentTrack: null,
            playlist: [],
            volume: 1.0,
            socket: null,
            mediaRecorder: null,
            audioContext: null,
            analyser: null,
            audioStream: null,
            musicStream: null,
            audioDestination: null,
            audioMixer: null
        };
        
        // ============= –≠–õ–ï–ú–ï–ù–¢–´ DOM =============
        const elements = {
            status: document.getElementById('status'),
            audioInput: document.getElementById('audioInput'),
            startBroadcastBtn: document.getElementById('startBroadcastBtn'),
            stopBroadcastBtn: document.getElementById('stopBroadcastBtn'),
            levelFill: document.getElementById('levelFill'),
            volumeSlider: document.getElementById('volumeSlider'),
            volumeValue: document.getElementById('volumeValue'),
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('fileInput'),
            playlist: document.getElementById('playlist'),
            playMusicBtn: document.getElementById('playMusicBtn'),
            pauseMusicBtn: document.getElementById('pauseMusicBtn'),
            stopMusicBtn: document.getElementById('stopMusicBtn'),
            nextTrackBtn: document.getElementById('nextTrackBtn'),
            musicPlayer: document.getElementById('musicPlayer'),
            chatBox: document.getElementById('chatBox')
        };
        
        // ============= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =============
        async function init() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LynchFM —Å—Ç—É–¥–∏–∏');
            await loadAudioDevices();
            setupEventListeners();
            connectToServer();
            addChatMessage('–°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'system');
        }
        
        // ============= –ó–ê–ì–†–£–ó–ö–ê –ê–£–î–ò–û–£–°–¢–†–û–ô–°–¢–í =============
        async function loadAudioDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
                elements.audioInput.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω...</option>';
                
                audioDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `–ú–∏–∫—Ä–æ—Ñ–æ–Ω ${audioDevices.indexOf(device) + 1}`;
                    elements.audioInput.appendChild(option);
                });
                
                if (audioDevices.length > 0) {
                    elements.audioInput.value = audioDevices[0].deviceId;
                    state.currentMicrophone = audioDevices[0].deviceId;
                }
                
                addChatMessage(`–ù–∞–π–¥–µ–Ω–æ ${audioDevices.length} –∞—É–¥–∏–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤`, 'system');
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤:', err);
                addChatMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤', 'system');
            }
        }
        
        // ============= –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ï–†–í–ï–†–£ =============
        function connectToServer() {
            state.socket = new WebSocket(SERVER_URL);
            
            state.socket.onopen = () => {
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                updateStatus('online');
                addChatMessage('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏', 'system');
            };
            
            state.socket.onclose = () => {
                console.log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                updateStatus('offline');
                addChatMessage('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'system');
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(connectToServer, 3000);
            };
            
            state.socket.onerror = (error) => {
                console.error('–û—à–∏–±–∫–∞ WebSocket:', error);
                addChatMessage(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'system');
            };
            
            state.socket.onmessage = (event) => {
                if (typeof event.data === 'string') {
                    try {
                        const data = JSON.parse(event.data);
                        handleServerMessage(data);
                    } catch (e) {
                        console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', event.data);
                    }
                }
            };
        }
        
        // ============= –ù–ê–ß–ê–õ–û –¢–†–ê–ù–°–õ–Ø–¶–ò–ò =============
        async function startBroadcast() {
            if (state.isBroadcasting) return;
            
            try {
                addChatMessage('–ó–∞–ø—É—Å–∫ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏...', 'system');
                
                // –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                const constraints = {
                    audio: {
                        deviceId: state.currentMicrophone ? 
                            { exact: state.currentMicrophone } : undefined,
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                };
                
                state.audioStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // –°–æ–∑–¥–∞–µ–º AudioContext –¥–ª—è –º–∏–∫—à–∏—Ä–æ–≤–∞–Ω–∏—è
                state.audioContext = new AudioContext();
                state.audioDestination = state.audioContext.createMediaStreamDestination();
                state.audioMixer = state.audioContext.createGain();
                state.audioMixer.gain.value = state.volume;
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                const micSource = state.audioContext.createMediaStreamSource(state.audioStream);
                micSource.connect(state.audioMixer);
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
                state.analyser = state.audioContext.createAnalyser();
                state.analyser.fftSize = 256;
                state.audioMixer.connect(state.analyser);
                state.audioMixer.connect(state.audioDestination);
                
                // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                startStreamingToServer();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                state.isBroadcasting = true;
                updateStatus('broadcasting');
                elements.startBroadcastBtn.disabled = true;
                elements.stopBroadcastBtn.disabled = false;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∑–≤—É–∫–∞
                updateAudioLevel();
                
                addChatMessage('–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –Ω–∞—á–∞—Ç–∞!', 'system');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏:', error);
                addChatMessage(`–û—à–∏–±–∫–∞: ${error.message}`, 'system');
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é: ' + error.message);
            }
        }
        
        // ============= –û–¢–ü–†–ê–í–ö–ê –ê–£–î–ò–û –ù–ê –°–ï–†–í–ï–† =============
        function startStreamingToServer() {
            if (!state.audioDestination || !state.socket) return;
            
            const audioStream = state.audioDestination.stream;
            
            // –°–æ–∑–¥–∞–µ–º MediaRecorder –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∞—É–¥–∏–æ
            state.mediaRecorder = new MediaRecorder(audioStream, {
                mimeType: 'audio/webm;codecs=opus',
                audioBitsPerSecond: 128000
            });
            
            state.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0 && state.socket && state.socket.readyState === WebSocket.OPEN) {
                    state.socket.send(event.data);
                }
            };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 500–º—Å
            state.mediaRecorder.start(500);
            
            console.log('üé§ –ù–∞—á–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
        }
        
        // ============= –û–°–¢–ê–ù–û–í–ö–ê –¢–†–ê–ù–°–õ–Ø–¶–ò–ò =============
        function stopBroadcast() {
            if (!state.isBroadcasting) return;
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å
            if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
                state.mediaRecorder.stop();
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–∏
            if (state.audioStream) {
                state.audioStream.getTracks().forEach(track => track.stop());
            }
            
            if (state.audioContext) {
                state.audioContext.close();
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            state.isBroadcasting = false;
            state.mediaRecorder = null;
            state.audioContext = null;
            state.analyser = null;
            state.audioStream = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateStatus('online');
            elements.startBroadcastBtn.disabled = false;
            elements.stopBroadcastBtn.disabled = true;
            
            addChatMessage('–¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', 'system');
        }
        
        // ============= –†–ê–ë–û–¢–ê –° MP3 –§–ê–ô–õ–ê–ú–ò =============
        function setupFileDrop() {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
            elements.dropZone.addEventListener('click', () => {
                elements.fileInput.click();
            });
            
            elements.dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.dropZone.classList.add('dragover');
            });
            
            elements.dropZone.addEventListener('dragleave', () => {
                elements.dropZone.classList.remove('dragover');
            });
            
            elements.dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.dropZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                handleAudioFiles(files);
            });
            
            elements.fileInput.addEventListener('change', (e) => {
                const files = e.target.files;
                handleAudioFiles(files);
            });
        }
        
        function handleAudioFiles(files) {
            const audioFiles = Array.from(files).filter(file => 
                file.type.startsWith('audio/') || file.name.toLowerCase().endsWith('.mp3')
            );
            
            if (audioFiles.length === 0) {
                addChatMessage('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∞—É–¥–∏–æ —Ñ–∞–π–ª–æ–≤', 'system');
                return;
            }
            
            audioFiles.forEach(file => {
                const track = {
                    id: Date.now() + Math.random(),
                    name: file.name.replace('.mp3', '').replace(/_/g, ' '),
                    file: file,
                    url: URL.createObjectURL(file),
                    duration: 0
                };
                
                state.playlist.push(track);
                addTrackToPlaylist(track);
            });
            
            addChatMessage(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${audioFiles.length} —Ç—Ä–µ–∫–æ–≤ –≤ –ø–ª–µ–π–ª–∏—Å—Ç`, 'system');
            updateMusicControls();
        }
        
        function addTrackToPlaylist(track) {
            // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ø–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç"
            const emptyItem = elements.playlist.querySelector('.empty');
            if (emptyItem) emptyItem.remove();
            
            const item = document.createElement('div');
            item.className = 'playlist-item';
            item.dataset.id = track.id;
            item.innerHTML = `
                <span>${track.name}</span>
                <button class="btn" onclick="playTrack('${track.id}')">‚ñ∂Ô∏è</button>
            `;
            
            elements.playlist.appendChild(item);
        }
        
        function playTrack(trackId) {
            const track = state.playlist.find(t => t.id === trackId);
            if (!track) return;
            
            state.currentTrack = track;
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
            elements.musicPlayer.pause();
            elements.musicPlayer.src = track.url;
            elements.musicPlayer.load();
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫ –º–∏–∫—à–µ—Ä—É –µ—Å–ª–∏ –∏–¥–µ—Ç —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è
            if (state.isBroadcasting && state.audioContext) {
                connectMusicToMixer();
            }
            
            elements.musicPlayer.play();
            state.isPlayingMusic = true;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updatePlaylistHighlight();
            updateMusicControls();
            
            addChatMessage(`–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ: ${track.name}`, 'system');
        }
        
        function connectMusicToMixer() {
            if (!state.audioContext || !state.audioMixer) return;
            
            // –°–æ–∑–¥–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–∑ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            const musicSource = state.audioContext.createMediaElementSource(elements.musicPlayer);
            
            // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (state.musicStream) {
                state.musicStream.disconnect();
            }
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫ –º–∏–∫—à–µ—Ä—É
            musicSource.connect(state.audioMixer);
            state.musicStream = musicSource;
        }
        
        // ============= –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–£–ó–´–ö–û–ô =============
        function updateMusicControls() {
            const hasTracks = state.playlist.length > 0;
            const canPlay = hasTracks && !state.isPlayingMusic;
            const canPauseStop = state.isPlayingMusic;
            
            elements.playMusicBtn.disabled = !canPlay;
            elements.pauseMusicBtn.disabled = !canPauseStop;
            elements.stopMusicBtn.disabled = !canPauseStop;
            elements.nextTrackBtn.disabled = !hasTracks;
            
            // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –ø–∞—É–∑—ã
            elements.pauseMusicBtn.textContent = elements.musicPlayer.paused ? 
                '‚ñ∂Ô∏è –í–æ—Å–ø—Ä.' : '‚è∏Ô∏è –ü–∞—É–∑–∞';
            elements.pauseMusicBtn.className = elements.musicPlayer.paused ? 
                'btn btn-success' : 'btn';
        }
        
        function updatePlaylistHighlight() {
            document.querySelectorAll('.playlist-item').forEach(item => {
                item.classList.remove('current');
                if (item.dataset.id === state.currentTrack?.id) {
                    item.classList.add('current');
                }
            });
        }
        
        // ============= –£–¢–ò–õ–ò–¢–´ =============
        function updateAudioLevel() {
            if (!state.analyser || !state.isBroadcasting) {
                elements.levelFill.style.width = '0%';
                return;
            }
            
            const dataArray = new Uint8Array(state.analyser.frequencyBinCount);
            state.analyser.getByteFrequencyData(dataArray);
            
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length;
            const percent = Math.min(average, 100);
            
            elements.levelFill.style.width = percent + '%';
            
            // –¶–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è
            if (percent > 80) {
                elements.levelFill.style.background = 'linear-gradient(90deg, #ff0000, #ff8800)';
            } else if (percent > 50) {
                elements.levelFill.style.background = 'linear-gradient(90deg, #ffff00, #00ff00)';
            } else {
                elements.levelFill.style.background = 'linear-gradient(90deg, #00ffff, #00ffaa)';
            }
            
            requestAnimationFrame(updateAudioLevel);
        }
        
        function updateStatus(newStatus) {
            elements.status.className = `status ${newStatus}`;
            
            switch(newStatus) {
                case 'offline':
                    elements.status.innerHTML = '‚èπÔ∏è –°—Ç–∞—Ç—É—Å: –û–§–§–õ–ê–ô–ù';
                    break;
                case 'online':
                    elements.status.innerHTML = '‚úÖ –°—Ç–∞—Ç—É—Å: –û–ù–õ–ê–ô–ù';
                    break;
                case 'broadcasting':
                    elements.status.innerHTML = 'üé§ –°—Ç–∞—Ç—É—Å: –í –≠–§–ò–†–ï!';
                    break;
            }
        }
        
        function addChatMessage(text, type = 'system') {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            
            elements.chatBox.appendChild(message);
            elements.chatBox.scrollTop = elements.chatBox.scrollHeight;
        }
        
        function handleServerMessage(data) {
            console.log('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        }
        
        // ============= –ù–ê–°–¢–†–û–ô–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –°–û–ë–´–¢–ò–ô =============
        function setupEventListeners() {
            // –í—ã–±–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
            elements.audioInput.addEventListener('change', (e) => {
                state.currentMicrophone = e.target.value;
                addChatMessage(`–í—ã–±—Ä–∞–Ω –º–∏–∫—Ä–æ—Ñ–æ–Ω: ${e.target.selectedOptions[0].text}`, 'system');
            });
            
            // –ö–Ω–æ–ø–∫–∏ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏
            elements.startBroadcastBtn.addEventListener('click', startBroadcast);
            elements.stopBroadcastBtn.addEventListener('click', stopBroadcast);
            
            // –ì—Ä–æ–º–∫–æ—Å—Ç—å
            elements.volumeSlider.addEventListener('input', (e) => {
                state.volume = e.target.value / 100;
                elements.volumeValue.textContent = `${e.target.value}%`;
                
                if (state.audioMixer) {
                    state.audioMixer.gain.value = state.volume;
                }
            });
            
            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º—É–∑—ã–∫–æ–π
            elements.playMusicBtn.addEventListener('click', () => {
                if (state.currentTrack) {
                    playTrack(state.currentTrack.id);
                } else if (state.playlist.length > 0) {
                    playTrack(state.playlist[0].id);
                }
            });
            
            elements.pauseMusicBtn.addEventListener('click', () => {
                if (elements.musicPlayer.paused) {
                    elements.musicPlayer.play();
                    state.isPlayingMusic = true;
                } else {
                    elements.musicPlayer.pause();
                    state.isPlayingMusic = false;
                }
                updateMusicControls();
            });
            
            elements.stopMusicBtn.addEventListener('click', () => {
                elements.musicPlayer.pause();
                elements.musicPlayer.currentTime = 0;
                state.isPlayingMusic = false;
                updateMusicControls();
            });
            
            elements.nextTrackBtn.addEventListener('click', () => {
                if (!state.currentTrack || state.playlist.length === 0) return;
                
                const currentIndex = state.playlist.findIndex(t => t.id === state.currentTrack.id);
                const nextIndex = (currentIndex + 1) % state.playlist.length;
                
                playTrack(state.playlist[nextIndex].id);
            });
            
            // –°–æ–±—ã—Ç–∏—è –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–∞
            elements.musicPlayer.addEventListener('play', () => {
                state.isPlayingMusic = true;
                updateMusicControls();
            });
            
            elements.musicPlayer.addEventListener('pause', () => {
                state.isPlayingMusic = false;
                updateMusicControls();
            });
            
            elements.musicPlayer.addEventListener('ended', () => {
                state.isPlayingMusic = false;
                addChatMessage('–¢—Ä–µ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'system');
                
                // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ç—Ä–µ–∫—É
                if (state.currentTrack && state.playlist.length > 1) {
                    const currentIndex = state.playlist.findIndex(t => t.id === state.currentTrack.id);
                    const nextIndex = (currentIndex + 1) % state.playlist.length;
                    playTrack(state.playlist[nextIndex].id);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
            setupFileDrop();
            
            // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', stopBroadcast);
        }
        
        // ============= –ì–õ–û–ë–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =============
        window.playTrack = playTrack;
        
        // ============= –ó–ê–ü–£–°–ö =============
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>