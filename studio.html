<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LynchFM - –°—Ç—É–¥–∏—è</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #111;
            color: white;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #00a8ff;
            text-align: center;
            margin-bottom: 30px;
        }
        .panel {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .offline { background: #ff4444; }
        .online { background: #44ff44; color: #000; }
        .broadcast { background: #ff4444; animation: pulse 1s infinite; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
            min-width: 150px;
        }
        .start-btn {
            background: #00a8ff;
            color: white;
        }
        .stop-btn {
            background: #ff4444;
            color: white;
        }
        .mp3-btn {
            background: #44cc44;
            color: white;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #222;
            border: 1px solid #333;
            border-radius: 5px;
            color: white;
        }
        
        .track-info {
            background: #222;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .level-meter {
            width: 100%;
            height: 10px;
            background: #222;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }
        .level-fill {
            height: 100%;
            background: #00a8ff;
            width: 0%;
            transition: width 0.1s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è LynchFM –°—Ç—É–¥–∏—è</h1>
        
        <div class="panel">
            <div class="status offline" id="status">–û–¢–ö–õ–Æ–ß–ï–ù–û</div>
            
            <div class="controls">
                <button class="start-btn" id="startBtn">–ù–ê–ß–ê–¢–¨ –≠–§–ò–†</button>
                <button class="stop-btn" id="stopBtn" disabled>–û–°–¢–ê–ù–û–í–ò–¢–¨</button>
            </div>
            
            <div class="level-meter">
                <div id="levelFill" class="level-fill"></div>
            </div>
            
            <div class="track-info">
                <input type="text" id="trackTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞">
                <input type="text" id="trackArtist" placeholder="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å">
                <button id="sendTrackBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç—Ä–µ–∫–µ</button>
            </div>
        </div>
        
        <div class="panel">
            <h3>üìÄ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ MP3</h3>
            
            <input type="file" id="mp3File" accept="audio/mp3,audio/*">
            
            <div class="controls">
                <button class="mp3-btn" id="playMp3Btn" disabled>‚ñ∂Ô∏è –í–∫–ª—é—á–∏—Ç—å MP3</button>
                <button class="stop-btn" id="stopMp3Btn" disabled>‚èπÔ∏è –í—ã–∫–ª—é—á–∏—Ç—å MP3</button>
            </div>
            
            <div id="currentMp3" style="margin: 10px 0; color: #888;">
                MP3 –Ω–µ –≤—ã–±—Ä–∞–Ω
            </div>
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–π –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è MP3 -->
    <audio id="mp3Player" style="display: none;"></audio>

    <script>
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        let ws = null;
        let isLive = false;
        let currentMp3 = null;
        let isMp3Playing = false;
        let audioContext = null;
        let mp3Source = null;
        let mediaRecorder = null;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const statusEl = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const levelFill = document.getElementById('levelFill');
        const mp3File = document.getElementById('mp3File');
        const playMp3Btn = document.getElementById('playMp3Btn');
        const stopMp3Btn = document.getElementById('stopMp3Btn');
        const currentMp3El = document.getElementById('currentMp3');
        const trackTitle = document.getElementById('trackTitle');
        const trackArtist = document.getElementById('trackArtist');
        const sendTrackBtn = document.getElementById('sendTrackBtn');
        const mp3Player = document.getElementById('mp3Player');
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsUrl = protocol + window.location.host;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É WebSocket');
                statusEl.textContent = '–ü–û–î–ö–õ–Æ–ß–ï–ù–û';
                statusEl.className = 'status online';
                startBtn.disabled = false;
            };
            
            ws.onclose = () => {
                console.log('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ WebSocket');
                statusEl.textContent = '–û–¢–ö–õ–Æ–ß–ï–ù–û';
                statusEl.className = 'status offline';
                startBtn.disabled = true;
                stopBtn.disabled = true;
                
                // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
            };
        }
        
        // –ù–∞—á–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é MP3
        async function startMp3Stream() {
            if (!currentMp3 || !isLive || !ws) {
                alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ —ç—Ñ–∏—Ä –∏ –≤—ã–±–µ—Ä–∏—Ç–µ MP3 —Ñ–∞–π–ª');
                return;
            }
            
            try {
                // –°–æ–∑–¥–∞–µ–º AudioContext
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // –°–æ–∑–¥–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–∑ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                mp3Source = audioContext.createMediaElementSource(mp3Player);
                
                // –°–æ–∑–¥–∞–µ–º destination –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∑–≤—É–∫–∞
                const destination = audioContext.createMediaStreamDestination();
                mp3Source.connect(destination);
                
                // –°–æ–∑–¥–∞–µ–º MediaRecorder –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∑–≤—É–∫–∞
                mediaRecorder = new MediaRecorder(destination.stream);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ WebSocket
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && ws.readyState === WebSocket.OPEN) {
                        ws.send(event.data);
                    }
                };
                
                // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 100–º—Å
                mediaRecorder.start(100);
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                await mp3Player.play();
                
                isMp3Playing = true;
                playMp3Btn.disabled = true;
                stopMp3Btn.disabled = false;
                
                console.log('MP3 –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–∞—á–∞—Ç–æ');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏
                updateVolumeLevel();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏ MP3:', error);
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å MP3
        function stopMp3Stream() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                mediaRecorder = null;
            }
            
            if (mp3Player) {
                mp3Player.pause();
                mp3Player.currentTime = 0;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            isMp3Playing = false;
            playMp3Btn.disabled = false;
            stopMp3Btn.disabled = true;
            
            console.log('MP3 –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        function updateVolumeLevel() {
            if (!isMp3Playing) {
                levelFill.style.width = '0%';
                return;
            }
            
            // –ü—Ä–æ—Å—Ç–∞—è –∏–º–∏—Ç–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è –∑–≤—É–∫–∞
            const randomLevel = Math.random() * 80 + 10;
            levelFill.style.width = randomLevel + '%';
            
            if (isMp3Playing) {
                requestAnimationFrame(updateVolumeLevel);
            }
        }
        
        // –ù–∞—á–∞—Ç—å —ç—Ñ–∏—Ä
        startBtn.addEventListener('click', () => {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                return;
            }
            
            isLive = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            playMp3Btn.disabled = false;
            
            statusEl.textContent = '–í –≠–§–ò–†–ï';
            statusEl.className = 'status broadcast';
            
            console.log('–≠—Ñ–∏—Ä –Ω–∞—á–∞—Ç');
        });
        
        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç—Ñ–∏—Ä
        stopBtn.addEventListener('click', () => {
            isLive = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            playMp3Btn.disabled = true;
            stopMp3Btn.disabled = true;
            
            statusEl.textContent = '–ü–û–î–ö–õ–Æ–ß–ï–ù–û';
            statusEl.className = 'status online';
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º MP3 –µ—Å–ª–∏ –∏–≥—Ä–∞–µ—Ç
            if (isMp3Playing) {
                stopMp3Stream();
            }
            
            console.log('–≠—Ñ–∏—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        });
        
        // –í—ã–±–æ—Ä MP3 —Ñ–∞–π–ª–∞
        mp3File.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('audio/') && !file.name.toLowerCase().endsWith('.mp3')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª (MP3)');
                mp3File.value = '';
                return;
            }
            
            currentMp3 = URL.createObjectURL(file);
            mp3Player.src = currentMp3;
            currentMp3El.textContent = '–í—ã–±—Ä–∞–Ω: ' + file.name;
            
            console.log('MP3 —Ñ–∞–π–ª –≤—ã–±—Ä–∞–Ω:', file.name);
        });
        
        // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è MP3
        playMp3Btn.addEventListener('click', startMp3Stream);
        stopMp3Btn.addEventListener('click', stopMp3Stream);
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—Ä–µ–∫–µ
        sendTrackBtn.addEventListener('click', () => {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                return;
            }
            
            const title = trackTitle.value.trim() || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç—Ä–µ–∫';
            const artist = trackArtist.value.trim() || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å';
            
            ws.send(JSON.stringify({
                type: 'track',
                title: title,
                artist: artist
            }));
            
            console.log('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–µ–∫–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:', artist + ' - ' + title);
            alert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–µ–∫–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–ª—É—à–∞—Ç–µ–ª—è–º!');
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            connectWebSocket();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('beforeunload', () => {
                if (ws) ws.close();
                if (currentMp3) URL.revokeObjectURL(currentMp3);
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ü–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è MP3
        mp3Player.addEventListener('ended', () => {
            if (isMp3Playing) {
                stopMp3Stream();
                alert('MP3 —Ñ–∞–π–ª –∑–∞–∫–æ–Ω—á–∏–ª—Å—è');
            }
        });
    </script>
</body>
</html>
