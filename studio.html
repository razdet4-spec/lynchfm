<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>LynchFM Studio — Вещание</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        .console { border: 1px solid #0f0; padding: 20px; max-width: 600px; margin: 0 auto; }
        button { background: #0f0; color: #000; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; }
        .live { color: red; animation: blink 1s infinite; display: none; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div class="console">
        <h2>LYNCH-AI BROADCASTER v1.0</h2>
        <p>Статус: <span id="status">Готов к труду и обороне</span></p>
        <div id="liveIndicator" class="live">● В ЭФИРЕ</div>
        <button id="startBtn">ЗАПУСТИТЬ ТРАНСЛЯЦИЮ</button>
    </div>

    <script>
        const socket = io();
        const startBtn = document.getElementById('startBtn');
        const status = document.getElementById('status');
        const liveIndicator = document.getElementById('liveIndicator');

        startBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });

                mediaRecorder.ondataavailable = async (e) => {
                    if (e.data.size > 0) {
                        const buffer = await e.data.arrayBuffer();
                        socket.emit('audio-stream', buffer);
                    }
                };

                // Отправляем кусочки звука каждые 200мс для минимальной задержки
                mediaRecorder.start(200);
                
                startBtn.disabled = true;
                status.innerText = "Трансляция идет...";
                liveIndicator.style.display = "block";
            } catch (err) {
                alert("Ошибка доступа к микрофону: " + err);
            }
        };
    </script>
</body>
</html>
